@*
    Denne partial page viser liste over eget inventory og ting på samme lokasjon som spilleren.
    Her kan man også utføre forskjellige kommandoer på de tingene.
*@

<style>
    h4::first-letter {
        font-size: 200%;
    }
</style>

<div style="width: 500px; height:400px; border: solid 1px; margin-top:2em;">
    <div style="float: right; width:50%; padding:1em">
        <h4>TING I ROMMET</h4>
        <select id="location_things_list" multiple="multiple" style="width: 100%;" size="10"></select>
        <button style="width: 100%">Take</button>
        <button style="width: 100%">Look at</button>
        <button style="width: 100%">Use</button>
        <button style="width: 100%">Write on</button>
    </div>

    <div style="width:50%; padding:1em">
        <h4>MINE TING</h4>
        <select id="inventory_things_list" multiple="multiple" style="width: 100%;" size="10"></select>
        <button style="width: 100%">Drop</button>
        <button style="width: 100%">Look at</button>
        <button style="width: 100%">Use</button>
        <button style="width: 100%">Write on</button>
    </div>
</div>


<script type="text/javascript">

    function add_thing_to_location_list(thingID, thingName) {
        $("<option>", { value: thingID, html: thingName }).appendTo("#location_things_list");
    }

    function remove_thing_from_location_list(thingID) {
        $("#location_things_list option[value='" + thingID + "']").remove();
    }

    function add_thing_to_inventory_list(thingID, thingName) {
        $("<option>", { value: thingID, html: thingName }).appendTo("#inventory_things_list");
    }

    function remove_thing_from_inventory_list(thingID) {
        $("#inventory_things_list option[value='" + thingID + "']").remove();
    }


    $(function () {

        var locationID = prompt("Please enter location ID: ");

        // Reference the auto-generated proxy for the hub.
        var thingHub = $.connection.thingHub;

        // Callback funksjon til thingHub
        thingHub.client.removeLocationThing = function (thingID) {
            remove_thing_from_location_list(thingID);
        };

        // Callback funksjon til thingHub
        thingHub.client.addLocationThing = function (thingID, thingName) {
            add_thing_to_location_list(thingID, thingName);
        }

        // Start the connection.
        $.connection.hub.start().done(function () {

            thingHub.server.joinLocation(locationID);


            // ___ TAKE ITEM ___
            $("#location_things_list").change(function () {
                if ($(this).val().length == 1) {
                    // Send request om å ta ting. Om vi får true tilbake, broadcaster vi det til andre i rommet og legger til inventory-listen.
                    $.get("api/Things/TakeThing/" + $(this).val(), function (data) {
                        if (data) {
                            thingHub.server.removeLocationThing(locationID, $("#location_things_list option:selected").val() + "");
                            add_thing_to_inventory_list($("#location_things_list option:selected").val(), $("#location_things_list option:selected").text());
                        }
                    });
                } else {
                    alert("Make up your mind...");
                }
            });


            // ___ DROP ITEM ___
            $("#inventory_things_list").change(function () {
                if ($(this).val().length == 1) {
                    // Send request om å droppe ting. Om vi får true tilbake, broadcaster vi det til andre i rommet og legger til i ting-i-rommet-listen
                    $.get("api/Things/DropThing/" + $(this).val(), function (data) {
                        if (data) {
                            thingHub.server.addLocationThing(locationID, $("#inventory_things_list option:selected").val() + "", $("#inventory_things_list option:selected").text());
                            remove_thing_from_inventory_list($("#inventory_things_list option:selected").val());
                        }
                    });
                } else {
                    alert("Make up your mind...");
                }
            });



        });

    });



    $(document).ready(function () {
        // Send an AJAX request
        $.getJSON("/api/Things/GetThingsInCurrentLocation/")
            .done(function (data) {
                // On success, 'data' contains a list of things.
                $.each(data, function (key, item) {
                    add_thing_to_location_list(item.ThingID, item.Name);
                });
            });

        $.getJSON("/api/Things/GetThingsInInventory/")
            .done(function (data) {
                // On success, 'data' contains a list of things.
                $.each(data, function (key, item) {
                    add_thing_to_inventory_list(item.ThingID, item.Name);
                });
            });
    });
    
</script>
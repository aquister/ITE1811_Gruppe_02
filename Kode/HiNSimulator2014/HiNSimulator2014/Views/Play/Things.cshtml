@*
    Denne partial page viser liste over eget inventory og ting på samme lokasjon som spilleren.
    Her kan man også utføre forskjellige kommandoer på de tingene.
*@

<div style="float: right; width:50%; padding:1em">
    <h4>THINGS IN ROOM</h4>
    <select id="location_things_list" multiple="multiple" style="width: 100%;" size="10"></select>
    <button id="btn_cmd_loc_thing_take" style="width: 100%">Take</button>
    <button id="btn_cmd_loc_thing_look" style="width: 100%">Look at</button>
    <button id="btn_cmd_loc_thing_write" style="width: 100%">Write on</button>
    <!--<button id="btn_cmd_loc_thing_use" style="width: 100%">Use</button>-->
</div>

<div style="width:50%; padding:1em">
    <h4>INVENTORY</h4>
    <select id="inventory_things_list" multiple="multiple" style="width: 100%;" size="10"></select>
    <button id="btn_cmd_inv_thing_drop" style="width: 100%">Drop</button>
    <button id="btn_cmd_inv_thing_look" style="width: 100%">Look at</button>
    <button id="btn_cmd_inv_thing_write" style="width: 100%">Write on</button>
    <!--<button id="btn_cmd_inv_thing_use" style="width: 100%">Use</button>-->
</div>

<script type="text/javascript">

    function add_thing_to_location_list(thingID, thingName) {
        $("<option>", { value: thingID, html: thingName }).appendTo("#location_things_list");
    }

    function remove_thing_from_location_list(thingID) {
        $("#location_things_list option[value='" + thingID + "']").remove();
    }

    function add_thing_to_inventory_list(thingID, thingName) {
        $("<option>", { value: thingID, html: thingName }).appendTo("#inventory_things_list");
    }

    function remove_thing_from_inventory_list(thingID) {
        $("#inventory_things_list option[value='" + thingID + "']").remove();
    }

    // API CALL: GET THING AND PRINT INFO TO STORYBOX
    function print_thing_info(thingID) {
        $.get("api/Things/GetThing/" + thingID, function (thing) {
            addTextToStoryBox("<br />");
            addTextToStoryBox("<b>Name:</b> &laquo;" + thing.Name + "&raquo;");
            addTextToStoryBox("<b>Description:</b> &laquo;" + thing.Description + "&raquo;");
            addTextToStoryBox("<b>Written on this:</b> &laquo;" + thing.WrittenText + "&raquo;");
            addTextToStoryBox("<br />");
        });
    }

    // API CALL: WRITE ON THING AFTER PROMTING USER FOR TEXT
    function write_on_thing(thingID) {
        $.get("api/Things/GetThing/" + thingID, function (thing) {
            if (thing.PlayerWritable) {
                var newWrittenText = prompt("What to write on this thing?", thing.WrittenText);
                $.post("/api/Things/WriteOnThing/" + thingID, { "": newWrittenText });
            } else {
                alert("Can not write on this thing!");
            }
        });
    }

    // BUTTON HOOK: LOOK AT LOCATION THING
    $("#btn_cmd_loc_thing_look").click(function () {
        if ($("#location_things_list").val().length == 1) {
            print_thing_info($("#location_things_list").val());
        } else {
            alert("Select only one item please...");
        }
    });

    // BUTTON HOOK: LOOK AT INVENTORY THING
    $("#btn_cmd_inv_thing_look").click(function () {
        if ($("#inventory_things_list").val().length == 1) {
            print_thing_info($("#inventory_things_list").val());
        } else {
            alert("Select only one item please...");
        }
    });


    // BUTTON HOOK: WRITE ON LOCATION THING
    $("#btn_cmd_loc_thing_write").click(function () {
        if ($("#location_things_list").val().length == 1) {
            write_on_thing($("#location_things_list").val());
        } else {
            alert("Select only one item please...");
        }
    });

    // BUTTON HOOK: WRITE ON INVENTORY THING
    $("#btn_cmd_inv_thing_write").click(function () {
        if ($("#inventory_things_list").val().length == 1) {
            write_on_thing($("#inventory_things_list").val());
        } else {
            alert("Select only one item please...");
        }
    });

    $(function () {

        var locationID = "1";// prompt("Please enter location ID: ");

        // Reference the auto-generated proxy for the hub.
        var thingHub = $.connection.thingHub;

        // Callback funksjon til thingHub
        thingHub.client.removeLocationThing = function (thingID, thingName) {
            remove_thing_from_location_list(thingID);
            addTextToStoryBox("<b>&laquo;" + thingName + "&raquo;</b> was removed from this location.");
        };

        // Callback funksjon til thingHub
        thingHub.client.addLocationThing = function (thingID, thingName) {
            add_thing_to_location_list(thingID, thingName);
            addTextToStoryBox("<b>&laquo;" + thingName + "&raquo;</b> was added to this location.");
        }

        // Start connection to thingHub
        $.connection.hub.start().done(function () {

            thingHub.server.joinLocation(locationID);

            // BUTTON HOOK: TAKE LOCATION ITEM
            $("#btn_cmd_loc_thing_take").click(function () {
                if ($("#location_things_list").val().length == 1) {
                    // Send request om å ta ting. Om vi får true tilbake, broadcaster vi det til andre i rommet og legger til inventory-listen.
                    $.get("api/Things/TakeThing/" + $("#location_things_list").val(), function (data) {
                        if (data) {
                            thingHub.server.removeLocationThing(locationID, $("#location_things_list option:selected").val(),
                                $("#location_things_list option:selected").text());
                            add_thing_to_inventory_list($("#location_things_list option:selected").val(),
                                $("#location_things_list option:selected").text());
                        } else {
                            alert("Can not take this thing");
                        }
                    });
                } else {
                    alert("Select only one item please...");
                }
            });

            // BUTTON HOOK: DROP INVENTORY ITEM
            $("#btn_cmd_inv_thing_drop").click(function () {
                if ($("#inventory_things_list").val().length == 1) {
                    // Send request om å droppe ting. Om vi får true tilbake, broadcaster vi det til andre i rommet og legger til i ting-i-rommet-listen
                    $.get("api/Things/DropThing/" + $("#inventory_things_list").val(), function (data) {
                        if (data) {
                            thingHub.server.addLocationThing(locationID, $("#inventory_things_list option:selected").val(),
                                $("#inventory_things_list option:selected").text());
                            remove_thing_from_inventory_list($("#inventory_things_list option:selected").val());
                        } else {
                            alert("Can not drop this thing");
                        }
                    });
                } else {
                    alert("Select only one item please...");
                }
            });



        });

    });



    $(document).ready(function () {

        // Send an AJAX request
        $.getJSON("/api/Things/GetThingsInCurrentLocation/")
            .done(function (data) {
                // On success, 'data' contains a list of things.
                $.each(data, function (key, item) {
                    add_thing_to_location_list(item.ThingID, item.Name);
                });
            });

        $.getJSON("/api/Things/GetThingsInInventory/")
            .done(function (data) {
                // On success, 'data' contains a list of things.
                $.each(data, function (key, item) {
                    add_thing_to_inventory_list(item.ThingID, item.Name);
                });
            });
    });
    
</script>